<!DOCTYPE html>
<html lang="en">

<head>
    <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Mukta">
    <meta charset="utf-8">
    <title>Basic network graph in d3.js</title>
    <style>
        .node_label {
            font-family: 'Mukta', serif;
            font-size: 11px;
            -webkit-touch-callout: none;
            /* iOS Safari */
            -webkit-user-select: none;
            /* Safari */
            -khtml-user-select: none;
            /* Konqueror HTML */
            -moz-user-select: none;
            /* Old versions of Firefox */
            -ms-user-select: none;
            /* Internet Explorer/Edge */
            user-select: none;
        }

        circle {
            cursor: pointer;
        }


    </style>
</head>




<section class="bg" style="padding-top: 20px; padding-bottom: 20px">
    <div class="container">
        <div class="row">

        </div>


        <!-- Load d3.js -->
        <script src="https://d3js.org/d3.v4.js"></script>

        <div id="git_commits_dag"></div>
        <script>

            var margin = { top: 10, right: 30, bottom: 30, left: 40 },
                width = 900 - margin.left - margin.right,
                height = 600 - margin.top - margin.bottom;



            d3.json("/data/network_graph.json", function (data) {
                console.log(data)
                var svg = d3.select("#git_commits_dag")
                    .append("svg")
                    .attr("width", width + margin.left + margin.right)
                    .attr("height", height + margin.top + margin.bottom)
                    .append("g")
                    .attr("transform",
                        "translate(" + margin.left + "," + margin.top + ")");


                var nodes_data = data.nodes;
                var links_data = data.links;
                console.log(nodes_data);
                console.log(links_data);

                var simulation = d3.forceSimulation()
                    .nodes(nodes_data);

                var link_force = d3.forceLink(links_data)
                    .id(function (d) { return d.id; });

                var charge_force = d3.forceManyBody()
                    .strength(-25);

                var center_force = d3.forceCenter(width / 2, height / 2);

                simulation
                    .force("charge_force", charge_force)
                    .force("center_force", center_force)
                    .force("links", link_force)
                    ;


                //add tick instructions: 
                simulation.on("tick", tickActions);

                //add encompassing group for the zoom 
                var g = svg.append("g")
                    .attr("class", "everything");

                //draw lines for the links 
                var link = g.append("g")
                    .attr("class", "links")
                    .selectAll("line")
                    .data(links_data)
                    .enter().append("line")
                    .attr("stroke-width", 2)
                    .style("stroke", "#aaa");

                var node = g.append("g")
                    .attr("class", "nodes")
                    .selectAll("circle")
                    .data(nodes_data)
                    .enter()
                    .append("circle");

                var circle = node
                    .attr("stroke", "#fff")
                    .attr("stroke-width", 1.5)
                    .attr("r", 8)
                    .style("fill", "#1f77b4");


                var lables = node.append("text")
                    .text(function (d) {
                        return d.date;
                    })
                    .attr('x', 18)
                    .attr('y', 3)
                    .attr("class", "node_label");
                    
                node.append("title")
                    .text(function (d) { return d.metadata; });



                var drag_handler = d3.drag()
                    .on("start", drag_start)
                    .on("drag", drag_drag)
                    .on("end", drag_end);

                drag_handler(node);
                //Zoom functions 
                function zoom_actions() {
                    g.attr("transform", d3.event.transform)
                }

                //add zoom capabilities 
                var zoom_handler = d3.zoom()
                    .on("zoom", zoom_actions);

                zoom_handler(svg);

                /** Functions **/


                //Drag functions 
                //d is the node 
                function drag_start(d) {
                    if (!d3.event.active) simulation.alphaTarget(0.3).restart();
                    d.fx = d.x;
                    d.fy = d.y;
                }

                //make sure you can't drag the circle outside the box
                function drag_drag(d) {
                    d.fx = d3.event.x;
                    d.fy = d3.event.y;
                }

                function drag_end(d) {
                    if (!d3.event.active) simulation.alphaTarget(0);
                    d.fx = null;
                    d.fy = null;
                }



                function tickActions() {
                    //update circle positions each tick of the simulation 
                    node
                        .attr("cx", function (d) { return d.x; })
                        .attr("cy", function (d) { return d.y; });

                    //update link positions 
                    link
                        .attr("x1", function (d) { return d.source.x; })
                        .attr("y1", function (d) { return d.source.y; })
                        .attr("x2", function (d) { return d.target.x; })
                        .attr("y2", function (d) { return d.target.y; });
                }
            });


        </script>

        </body>

</html>